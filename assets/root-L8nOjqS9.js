import{t as e,b as l,v as q,L as D,w as Q,M as ee,x as te,S as ne,y as re,O as se}from"./index-BdwX92X6.js";import{L as oe}from"./Logo-BidD8VYU.js";import{u as ae,a as Y}from"./use-dark-mode-CNQh-kvv.js";import{B as ie,c as j,R as O,A as G,e as T,a as $,P as de,G as ce,X as le,E as ue,b as B,r as pe,t as W,f as ge,d as me,g as fe,h as he,i as xe,j as ze,k as _,T as be}from"./createLucideIcon-DsSOLlez.js";import{e as H}from"./expeditionIndex-EGyna6u9.js";import{puzzleIndex as M}from"./puzzleIndex-mVLt7SRB.js";import{L as ve}from"./loader-circle-cVGC957E.js";function we(t,r){return()=>ae(...ye(t,r))}function ye(t,r){const{version:o,defaultValue:i,migrations:n,serializer:s,deserializer:h,initializeWithValue:x}=r;return Pe(n,o),[t,i,{serializer:f=>JSON.stringify({version:o,value:s?s(f):f}),deserializer:f=>{try{const u=JSON.parse(f);return u.version===o?h?h(u.value):u.value:u.version>o?(console.warn(`[Storage Migration] Stored version (${u.version}) is newer than current version (${o}). Resetting to default.`),i):ke(u.value,u.version,o,n,i)}catch(u){return console.error("[Storage Migration] Error during migration:",u),i}},initializeWithValue:x}]}function Pe(t,r){if(t)for(const[o,i]of Object.entries(t)){const n=parseInt(o,10),s=i.to??n+1;if(s<=n)throw new Error(`[Storage Migration] Invalid migration: version ${n} cannot migrate to ${s} (backwards or circular migration)`);s>r&&console.warn(`[Storage Migration] Migration from version ${n} targets version ${s}, which exceeds the current target version ${r}. This migration may not be reachable.`)}}function ke(t,r,o,i,n){if(!i)return console.warn("[Storage Migration] No migrations defined. Resetting to default value."),n;let s=r,h=t;const x=100;let g=0;for(;s<o;){if(g++,g>x)return console.error(`[Storage Migration] Migration exceeded maximum iterations (${x}). Possible infinite loop. Resetting to default.`),n;const f=i[s];if(!f)return console.warn(`[Storage Migration] No migration found for version ${s}. This is a breaking change. Resetting to default value.`),n;try{h=f.migrate(h);const u=f.to??s+1;if(u<=s)return console.error(`[Storage Migration] Migration from version ${s} did not advance (next: ${u}). Resetting to default.`),n;s=u}catch(u){return console.error(`[Storage Migration] Migration from version ${s} failed:`,u),n}}return h}function V(){const[t,r]=Y();return e.jsx(ie,{variant:"ghost",size:"icon",onClick:()=>r(!t),"aria-label":t?"Switch to light mode":"Switch to dark mode",suppressHydrationWarning:!0,children:e.jsxs("div",{children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:j(!t&&"hidden"),suppressHydrationWarning:!0,children:[e.jsx("circle",{cx:"12",cy:"12",r:"4"}),e.jsx("path",{d:"M12 2v2"}),e.jsx("path",{d:"M12 20v2"}),e.jsx("path",{d:"m4.93 4.93 1.41 1.41"}),e.jsx("path",{d:"m17.66 17.66 1.41 1.41"}),e.jsx("path",{d:"M2 12h2"}),e.jsx("path",{d:"M20 12h2"}),e.jsx("path",{d:"m6.34 17.66-1.41 1.41"}),e.jsx("path",{d:"m19.07 4.93-1.41 1.41"})]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:j(t&&"hidden"),suppressHydrationWarning:!0,children:e.jsx("path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"})})]})})}const Ee=l.forwardRef(function(r,o){const[i,n]=l.useState(!1),s=q(),h=g=>s.pathname===g,x=[{path:O.PUZZLES,label:"Puzzles"},{path:O.EXPEDITIONS,label:"Expeditions"},{path:O.PROGRESS,label:"Progress"}];return e.jsxs(e.Fragment,{children:[e.jsx("nav",{ref:o,className:"sticky top-0 z-[1000] border-b border-border bg-card",children:e.jsx("div",{className:"container mx-auto px-6",children:e.jsxs("div",{className:"flex h-16 items-center justify-between",children:[e.jsxs(D,{to:"/",className:"flex items-center gap-3 text-nav-foreground no-underline",children:[e.jsx(oe,{className:"h-10 w-10 text-nav-foreground"}),e.jsx("span",{className:"text-[1.25rem] font-semibold leading-none",children:"Puzzlestone Peak"})]}),e.jsxs("div",{className:"hidden items-center gap-6 md:flex",children:[e.jsx("ul",{className:"flex items-center gap-8",children:x.map(g=>e.jsx("li",{children:e.jsx(D,{to:g.path,className:j("relative pb-2 text-[1rem] font-medium text-nav-foreground no-underline after:absolute after:bottom-0 after:left-0 after:h-[2px] after:w-0 after:bg-nav-foreground after:transition-all after:duration-200 hover:after:w-full",h(g.path)&&"after:w-full"),children:g.label})},g.path))}),e.jsx(V,{})]}),e.jsxs("button",{onClick:()=>n(!i),className:"flex h-8 w-8 cursor-pointer flex-col justify-around border-none bg-transparent p-1 text-nav-foreground md:hidden","aria-label":"Toggle mobile menu","aria-expanded":i,children:[e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"}),e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"}),e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"})]})]})})}),e.jsx("div",{className:j("fixed left-0 right-0 top-16 z-[999] border-b border-border bg-card shadow-lg transition-all duration-300 md:hidden",i?"translate-y-0 opacity-100":"pointer-events-none -translate-y-full opacity-0"),children:e.jsxs("div",{className:"px-6 pb-6 pt-4",children:[e.jsx("ul",{className:"flex flex-col gap-3",children:x.map(g=>e.jsx("li",{children:e.jsx(D,{to:g.path,onClick:()=>n(!1),className:j("flex items-center border-l-[3px] px-4 py-3.5 text-base font-medium text-nav-foreground no-underline transition-all duration-200",h(g.path)?"border-l-nav-foreground bg-muted font-semibold":"border-l-transparent hover:border-l-nav-foreground hover:bg-muted"),children:g.label})},g.path))}),e.jsx("div",{className:"mt-4 flex justify-center border-t border-border pt-4",children:e.jsx(V,{})})]})})]})}),J=l.createContext(null);function je({children:t}){const[r,o]=l.useState(0);return e.jsx(J.Provider,{value:{navHeight:r,setNavHeight:o},children:t})}function Se(){const t=l.useContext(J);if(!t)throw new Error("useSetNavHeight must be used within a NavHeightProvider");return t.setNavHeight}function Ne({children:t}){const r=l.useRef(null),o=Se();return l.useEffect(()=>{const i=()=>{r.current&&o(r.current.offsetHeight)};return i(),window.addEventListener("resize",i),()=>{window.removeEventListener("resize",i)}},[o]),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Ee,{ref:r}),e.jsx("main",{children:t})]})}function Be({children:t}){return e.jsx(je,{children:e.jsx(Ne,{children:t})})}const Me="puzzlestoneProgress",Ie="puzzlestoneProgress_backup",Ce=2,Re=20,Ae=we(Me,{version:Ce,defaultValue:{completedPuzzles:[],completedExpeditions:[],earnedBadges:[],lastSeenPuzzles:[]},serializer:t=>JSON.stringify(t),deserializer:t=>{try{const r=JSON.parse(t),o=Te(r);return _e(o)}catch(r){console.error("[Progress] Failed to deserialize progress, backing up and resetting:",r);try{const o=new Date().toISOString(),i=`${Ie}_${o}`;localStorage.setItem(i,t),console.warn(`[Progress] Corrupted data saved to "${i}". Check localStorage to recover your progress manually.`)}catch(o){console.error("[Progress] Failed to save backup:",o)}return{completedPuzzles:[],completedExpeditions:[],earnedBadges:[],lastSeenPuzzles:[]}}}});function Te(t){const r=new Set(M.map(n=>n.id)),o=new Set(H.map(n=>n.id)),i=new Set(G.map(n=>n.id));return{completedPuzzles:t.completedPuzzles.filter(n=>r.has(n.id)),completedExpeditions:t.completedExpeditions.filter(n=>o.has(n.id)),earnedBadges:t.earnedBadges.filter(n=>i.has(n.badgeId)),lastSeenPuzzles:t.lastSeenPuzzles.filter(n=>r.has(n.id))}}function _e(t){const r=I(t),o=new Set(t.earnedBadges.map(n=>n.badgeId)),i=[];for(const n of G){if(o.has(n.id))continue;T(n,r).type==="done"&&i.push({badgeId:n.id,earnedAt:Date.now()})}return i.length>0?{...t,earnedBadges:[...t.earnedBadges,...i]}:t}function I(t){const r=new Map(t.completedPuzzles.map(c=>[c.id,c])),o=new Map(t.completedExpeditions.map(c=>[c.id,c])),i=new Map(t.earnedBadges.map(c=>[c.badgeId,c])),n=[];for(const c of ce){const b=M.filter(E=>E.difficulty===c),S=b.filter(E=>r.has(E.id)).length,k=b.length;n.push({difficulty:c,completed:S,total:k,percentage:k>0?Math.round(S/k*100):0})}const s=M.filter(c=>c.difficulty!=="open").length,h=M.filter(c=>c.difficulty!=="open"&&r.has(c.id)).length,x=H.length,g=H.filter(c=>o.has(c.id)).length;let f=0;for(const c of M)r.has(c.id)&&(f+=le[c.difficulty]);for(const c of t.earnedBadges){const b=$.get(c.badgeId);b?.xp&&(f+=b.xp)}f+=g*ue;const u=B.slice().reverse().find(c=>f>=c.minXP)||B[0],y=B.findIndex(c=>c.id===u.id),P=y<B.length-1?B[y+1]:null,C=P?P.minXP-f:null;return{completedPuzzles:r,completedExpeditions:o,earnedBadges:i,lastSeenPuzzles:t.lastSeenPuzzles.slice().sort((c,b)=>b.viewedAt-c.viewedAt),totalXP:f,currentRank:u,nextRank:P,xpToNextRank:C,progressByDifficulty:n,totalProgress:{completed:h,total:s,percentage:s>0?Math.round(h/s*100):0},expeditionProgress:{completed:g,total:x,percentage:x>0?Math.round(g/x*100):0}}}function Le({children:t,onBadgesEarned:r,onRankUp:o}){const[i,n]=Ae(),[s,h]=l.useState(()=>I(i)),x=l.useRef(r),g=l.useRef(o);l.useEffect(()=>{x.current=r,g.current=o},[r,o]),l.useEffect(()=>{const a=I(i);h(a)},[i]);const f=l.useCallback((a,d,m,z)=>{const v=[],w=G.filter(p=>{switch(z){case"puzzle":return p.condition.type==="content-badge"&&p.condition.contentType==="puzzle"||p.condition.type==="rank"||p.condition.type==="custom";case"expedition":return p.condition.type==="content-badge"&&p.condition.contentType==="expedition"||p.condition.type==="rank"||p.condition.type==="custom";default:return!0}});for(const p of w){const L=T(p,m),R=d.earnedBadges.has(p.id),K=L.type==="done";if(K&&!R){const N=Date.now();a.earnedBadges.push({badgeId:p.id,earnedAt:N}),m.earnedBadges.set(p.id,{badgeId:p.id,earnedAt:N}),v.push({badge:p,earnedAt:N})}else!K&&R&&(a.earnedBadges=a.earnedBadges.filter(N=>N.badgeId!==p.id),m.earnedBadges.delete(p.id))}return v},[]),u=l.useCallback((a,d)=>{n(m=>{const z=a(m),v=I(m),w=I(z),p=f(z,v,w,d);return p.length>0&&x.current&&x.current(p),w.currentRank.id!==v.currentRank.id&&g.current&&g.current(v.currentRank,w.currentRank),h(w),z})},[f]),y=l.useCallback(a=>{a&&u(d=>({...d,completedPuzzles:d.completedPuzzles.some(m=>m.id===a)?d.completedPuzzles:[...d.completedPuzzles,{id:a,completedAt:Date.now()}]}),"puzzle")},[u]),P=l.useCallback(a=>{a&&u(d=>({...d,completedPuzzles:d.completedPuzzles.filter(m=>m.id!==a)}),"puzzle")},[u]),C=l.useCallback(a=>s.completedPuzzles.has(a),[s.completedPuzzles]),c=l.useCallback(a=>{a&&n(d=>{const m=Date.now(),z=d.lastSeenPuzzles.filter(p=>p.id!==a),v=[{id:a,viewedAt:m},...z].slice(0,Re),w={...d,lastSeenPuzzles:v};return h(p=>({...p,lastSeenPuzzles:v.slice().sort((L,R)=>R.viewedAt-L.viewedAt)})),w})},[]),b=l.useCallback(a=>{const d=s.lastSeenPuzzles;return a!==void 0?d.slice(0,a):d},[s.lastSeenPuzzles]),S=l.useCallback(a=>{a&&u(d=>({...d,completedExpeditions:d.completedExpeditions.some(m=>m.id===a)?d.completedExpeditions:[...d.completedExpeditions,{id:a,completedAt:Date.now()}]}),"expedition")},[u]),k=l.useCallback(a=>{a&&u(d=>({...d,completedExpeditions:d.completedExpeditions.filter(m=>m.id!==a)}),"expedition")},[u]),E=l.useCallback(a=>s.completedExpeditions.has(a),[s.completedExpeditions]),U=l.useCallback(a=>{const d=$.get(a);return d?T(d,s):{type:"not-discovered"}},[s]),X=l.useCallback(a=>{const d=s.earnedBadges.get(a);if(d)return{type:"done",completedDate:new Date(d.earnedAt)};const m=$.get(a);if(!m)return{type:"hidden"};const z=T(m,s);switch(z.type){case"done":return{type:"done",completedDate:new Date};case"not-discovered":return{type:"hidden"};case"not-done":return{type:"not-done"};case"progress":return{type:"progress",current:z.current,total:z.total,percentage:z.percentage,label:z.label}}},[s]),F=l.useCallback(()=>Array.from(s.earnedBadges.values()).sort((a,d)=>d.earnedAt-a.earnedAt).map(a=>({badgeId:a.badgeId,earnedAt:a.earnedAt})),[s.earnedBadges]),Z=l.useMemo(()=>({userProgress:s,getBadgeProgress:U,getBadgeCompletionState:X,getRecentBadges:F,markPuzzleComplete:y,markPuzzleIncomplete:P,isPuzzleComplete:C,markPuzzleViewed:c,getLastSeenPuzzles:b,markExpeditionComplete:S,markExpeditionIncomplete:k,isExpeditionComplete:E,onBadgesEarned:r,onRankUp:o}),[s,U,X,F,y,P,C,c,b,S,k,E,r,o]);return e.jsx(de.Provider,{value:Z,children:t})}const De=300*1e3,A={BADGE_TITLE:t=>`Badge Earned: ${t}`,BADGE_DESCRIPTION:(t,r)=>`${t}${r?` (+${r} XP)`:""}`,RANK_UP_TITLE:t=>`Rank Up: ${t}`,RANK_UP_DESCRIPTION:"You've ascended to a new rank!"};function Oe(t,r){const o=Date.now(),i=new Set(t.map(n=>n.badge.id));return t.filter(({badge:n,earnedAt:s})=>!(r.has(n.id)||o-s<De&&o-s>1e3||i.has(ge.id)&&[me.id,fe.id,he.id,xe.id,ze.id].includes(n.id)))}function $e(){const t=l.useRef(new Set(pe.map(i=>i.id))).current,r=l.useCallback(i=>{Oe(i,t).forEach(({badge:s})=>{W.success(A.BADGE_TITLE(s.title),{description:A.BADGE_DESCRIPTION(s.description,s.xp)})})},[t]),o=l.useCallback((i,n)=>{W.success(A.RANK_UP_TITLE(n.name),{description:A.RANK_UP_DESCRIPTION})},[]);return{handleBadgesEarned:r,handleRankUp:o}}/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ge=_("circle-check",He);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Xe=_("circle-x",Ue);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Ke=_("info",Fe);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],Ve=_("triangle-alert",We),Ye=({...t})=>e.jsx(be,{className:"toaster group",icons:{success:e.jsx(Ge,{className:"!text-success"}),error:e.jsx(Xe,{className:"!text-destructive"}),warning:e.jsx(Ve,{className:"!text-warning"}),info:e.jsx(Ke,{className:"!text-info"}),loading:e.jsx(ve,{className:"animate-spin"})},toastOptions:{unstyled:!0,closeButton:!0,duration:1e9,classNames:{toast:"bg-card text-card-foreground border border-border shadow-lg rounded-lg font-sans p-4 flex gap-3 items-start w-full max-w-md data-[type=success]:border-success data-[type=error]:border-destructive data-[type=warning]:border-warning data-[type=info]:border-info",title:"font-semibold text-base",description:"text-muted-foreground text-sm mt-1",actionButton:"bg-primary text-primary-foreground hover:bg-primary/90 rounded-md px-3 py-2 font-medium text-sm transition-colors",cancelButton:"bg-muted text-muted-foreground hover:bg-muted/80 rounded-md px-3 py-2 text-sm transition-colors",closeButton:"size-auto bg-card hover:bg-muted !transition-colors text-card-foreground border border-border rounded-full p-1 absolute top-0 right-0 transform-[translate(50%,-50%)] [&>svg]:size-4 cursor-pointer"}},...t});function rt({children:t}){const[r]=Y();return e.jsxs("html",{lang:"en",className:j(r?"dark":void 0),suppressHydrationWarning:!0,children:[e.jsxs("head",{children:[e.jsx("meta",{charSet:"UTF-8"}),e.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),e.jsx("meta",{name:"color-scheme",content:"dark light"}),e.jsx("script",{dangerouslySetInnerHTML:{__html:`
              (function initTheme() {
                if (localStorage.getItem('darkmode') === '1') {
                  document.documentElement.classList.add('dark');
                }
              })();
            `}}),e.jsx(ee,{}),e.jsx(te,{})]}),e.jsxs("body",{children:[t,e.jsx(ne,{}),e.jsx(re,{})]})]})}const st=Q(function(){const{handleBadgesEarned:r,handleRankUp:o}=$e();return e.jsxs(Le,{onBadgesEarned:r,onRankUp:o,children:[e.jsx(Ye,{}),e.jsx(Be,{children:e.jsx(se,{})})]})});export{rt as Layout,st as default};
