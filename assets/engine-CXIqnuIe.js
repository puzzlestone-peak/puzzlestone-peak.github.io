function C(t,e){if(e.length===0)return t;const n=new Set(e);return t.filter(i=>!n.has(i.id))}function w(t,e,n,i){if(e==="any")return t;const r=i==="puzzle"?n.completedPuzzles:n.completedExpeditions;return t.filter(f=>{const o=r.has(f.id);return e==="done"?o:!o})}function M(t,e,n){const i=e==="auto"?n==="development":e==="dev";return t.filter(r=>{const f=r.published??"published";return!(f==="not-published"||!i&&f==="dev-only")})}function L(t,e,n){const i=new Set(e.slice(-n));return t.filter(r=>i.has(r.id))}function b(t,e){const n=new Set(e);return t.filter(i=>n.has(i.difficulty))}function P(t,e,n){return e==="any"?t:n?t.filter(i=>!i.prerequisites||i.prerequisites.length===0?!0:i.prerequisites.every(r=>n.completedExpeditions.has(r))):t.filter(i=>!i.prerequisites||i.prerequisites.length===0)}function k(t,e,n){switch(e.type){case"exclude":return C(t,e.excludeList);case"completion":{const i="difficulty"in t[0]?"puzzle":"expedition";return w(t,e.status,n.userProgress,i)}case"publication":return M(t,e.mode,n.environment);case"recently-seen":return L(t,n.viewHistory??[],e.maxHistory);case"difficulty":return"difficulty"in t[0]?b(t,e.difficulties):t;case"prerequisites":return"prerequisites"in t[0]?P(t,e.mode,e.userProgress??n.userProgress):t;default:return t}}function q(t,e,n){let i=t;for(const r of e)if(i=k(i,r,n),i.length===0)break;return i}const p=["easy","medium","advanced","expert","master","open"];function E(t){return p.indexOf(t)}function B(t,e){const n=E(t),i=[t];if(e!==void 0&&e>0)for(let r=1;r<=e;r++){const f=n+r,o=n-r;f<p.length&&i.push(p[f]),o>=0&&i.push(p[o])}for(let r=(e??0)+1;r<p.length;r++){const f=n+r,o=n-r;f<p.length&&i.push(p[f]),o>=0&&i.push(p[o])}return i}function H(t){const e=new Map;for(const n of p)e.set(n,0);for(const n of t)e.set(n.difficulty,(e.get(n.difficulty)??0)+1);return e}function O(t,e){const n=new Set;for(const i of p){const r=t.filter(o=>o.difficulty===i);r.every(o=>e.completedPuzzles.has(o.id))&&r.length>0&&n.add(i)}return n}function T(t,e,n,i,r,f){if(e.length>=n)return e;const o=B(i,r),l=[...e],s=new Set(e.map(a=>a.id));for(const a of o){if(l.length>=n)break;const u=b(t,[a]).filter(c=>!s.has(c.id)&&!f.completedPuzzles.has(c.id));for(const c of u){if(l.length>=n)break;l.push(c),s.add(c.id)}}return l}function $(t,e,n,i,r,f){if(e.length>=n)return e;const o=r?O(t,f):new Set,l=[...e],s=new Set(e.map(u=>u.id)),a=t.filter(u=>!s.has(u.id)&&!f.completedPuzzles.has(u.id));for(;l.length<n&&a.length>0;){const u=H(l),c=p.filter(h=>!o.has(h)),y=c.map(h=>u.get(h)??0),m=Math.min(...y),d=c.filter(h=>(u.get(h)??0)<=m);if(d.length===0)break;const x=d[Math.floor(Math.random()*d.length)],D=a.findIndex(h=>h.difficulty===x);if(D===-1){o.add(x);continue}const z=a[D];l.push(z),s.add(z.id),a.splice(D,1)}return l}function j(t,e,n,i,r,f){if(e.length>=n)return e;const o="difficulty"in t[0]?"puzzle":"expedition",l=new Set(e.map(c=>c.id)),s=i?new Set(r):new Set,a=w(t,"done",f,o).filter(c=>!l.has(c.id)&&!s.has(c.id)),u=[...e];for(const c of a){if(u.length>=n)break;u.push(c)}return u}function U(t,e,n){if(e.length>=n)return e;const i=new Set(e.map(o=>o.id)),r=P(t,"any").filter(o=>!i.has(o.id)),f=[...e];for(const o of r){if(f.length>=n)break;f.push(o)}return f}function Y(t,e,n,i,r){switch(i.type){case"difficulty":{if(!("difficulty"in t[0]))return e;const f=t,o=e;if(i.strategy==="spiral"){const l=i.preferredDifficulty??r.currentDifficulty??"medium",s=i.allowRange??0;return T(f,o,n,l,s,r.userProgress)}else if(i.strategy==="balanced"){const l=i.balanceConstraint?.maxDiff??1,s=i.excludeFullyCompletedDifficulties??!0;return $(f,o,n,l,s,r.userProgress)}return e}case"completion":return i.allowCompleted?j(t,e,n,i.respectExcludeList??!1,r.excludeList,r.userProgress):e;case"prerequisites":return"prerequisites"in t[0]?U(t,e,n):e;default:return e}}function _(t,e,n,i,r){let f=e;for(const o of i)if(f=Y(t,f,n,o,r),f.length>=n)break;return f}function A(t){let e=0;for(let n=0;n<t.length;n++){const i=t.charCodeAt(n);e=(e<<5)-e+i,e=e&e}return Math.abs(e)}class G{seed;constructor(e){this.seed=typeof e=="string"?A(e):e}next(){return this.seed=1664525*this.seed+1013904223>>>0,this.seed/4294967296}nextInt(e,n){return Math.floor(this.next()*(n-e))+e}shuffle(e){const n=[...e];for(let i=n.length-1;i>0;i--){const r=this.nextInt(0,i+1);[n[i],n[r]]=[n[r],n[i]]}return n}}function F(t){return new G(t)}function R(t){const e=new Date().toISOString().split("T")[0];return`${t}-${e}`}function v(t,e){if(e)return F(e).shuffle(t);const n=[...t];for(let i=n.length-1;i>0;i--){const r=Math.floor(Math.random()*(i+1));[n[i],n[r]]=[n[r],n[i]]}return n}function J(t,e,n){const i=[],r=n?F(n):null;for(const f of e){const o=t.filter(l=>l.difficulty===f);if(o.length>0){const l=r?r.nextInt(0,o.length):Math.floor(Math.random()*o.length);i.push(o[l])}}return i}function K(t,e){return t.slice(0,e)}function N(t,e,n){switch(e.type){case"random":return v(t,n);case"random-by-difficulty":return t.length===0||!("difficulty"in t[0])?v(t,n):J(t,e.difficulties,n);case"recent-first":return K(t,e.maxCount);default:return t}}const g=["easy","medium","advanced","expert","master","open"];function S(t){const e=new Map;for(const n of g)e.set(n,0);for(const n of t)e.set(n.difficulty,(e.get(n.difficulty)??0)+1);return e}function Q(t,e){const n=new Set;for(const i of g){const r=t.filter(o=>o.difficulty===i);if(r.length===0)continue;r.every(o=>e.completedPuzzles.has(o.id))&&n.add(i)}return n}function V(t,e,n,i){const r=g.filter(s=>!n||!i.has(s));if(r.length===0)return!0;const f=r.map(s=>t.get(s)??0),o=Math.min(...f);return Math.max(...f)-o<=e}function W(t,e,n,i,r){if(t.length===0)return t;const f=n?Q(i,r):new Set;let o=[...t],l=S(o);for(;!V(l,e,n,f);){const s=g.filter(d=>!n||!f.has(d));if(s.length===0)break;const a=s.map(d=>l.get(d)??0),u=Math.max(...a),c=s.find(d=>l.get(d)===u);if(!c)break;const y=o.filter(d=>d.difficulty===c);if(y.length===0)break;const m=y[Math.floor(Math.random()*y.length)];o=o.filter(d=>d.id!==m.id),l=S(o)}return o}function X(t,e,n,i){if(!e)return t;switch(e.type){case"difficulty-balance":return W(t,e.maxDiff,e.excludeFullyCompleted,n,i);default:return t}}function I(t,e,n){let i=q(e,t.filters,{userProgress:n.userProgress,environment:n.environment,excludeList:n.excludeList,viewHistory:n.viewHistory});i.length<t.count&&t.fallbacks.length>0&&(i=_(e,i,t.count,t.fallbacks,{userProgress:n.userProgress,excludeList:n.excludeList,currentDifficulty:n.currentDifficulty}));let r=N(i,t.selectionStrategy,n.seed);return t.balancingStrategy&&r.length>0&&"difficulty"in r[0]&&(r=X(r,t.balancingStrategy,e,n.userProgress)),r.slice(0,t.count)}function ee(t,e){return I(t,e.allPuzzles,{userProgress:e.userProgress,excludeList:e.excludeList,environment:e.environment,currentDifficulty:e.currentPuzzleDifficulty,viewHistory:e.viewHistory,seed:e.seed})}function te(t,e){return I(t,e.allExpeditions,{userProgress:e.userProgress,excludeList:e.excludeList,environment:e.environment,seed:e.seed})}export{te as a,R as g,ee as r};
