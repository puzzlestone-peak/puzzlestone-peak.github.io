import{a as l,p as z}from"./chunk-OIYGIGL5-B3h4I76-.js";import{b as m}from"./Button-BGSe_H6B.js";function p(r,e,t="",o){return typeof e=="object"?()=>m(...x(r,e)):()=>m(...P(r,e,t,o))}function P(r,e,t="",o){const i={...o,serializer:n=>JSON.stringify({version:e,value:n}),deserializer:n=>{const s=JSON.parse(n);return s.version!==e?t:o?.deserializer?o.deserializer(s.value):s.value}};return[r,t,i]}function x(r,e){const{version:t,defaultValue:o,migrations:i,serializer:n,deserializer:s}=e;return S(i,t),[r,o,{serializer:c=>JSON.stringify({version:t,value:n?n(c):c}),deserializer:c=>{try{const a=JSON.parse(c);return a.version===t?s?s(a.value):a.value:a.version>t?(console.warn(`[Storage Migration] Stored version (${a.version}) is newer than current version (${t}). Resetting to default.`),o):w(a.value,a.version,t,i,o)}catch(a){return console.error("[Storage Migration] Error during migration:",a),o}}}]}function S(r,e){if(r)for(const[t,o]of Object.entries(r)){const i=parseInt(t,10),n=o.to??i+1;if(n<=i)throw new Error(`[Storage Migration] Invalid migration: version ${i} cannot migrate to ${n} (backwards or circular migration)`);n>e&&console.warn(`[Storage Migration] Migration from version ${i} targets version ${n}, which exceeds the current target version ${e}. This migration may not be reachable.`)}}function w(r,e,t,o,i){if(!o)return console.warn("[Storage Migration] No migrations defined. Resetting to default value."),i;let n=e,s=r;const g=100;let c=0;for(;n<t;){if(c++,c>g)return console.error(`[Storage Migration] Migration exceeded maximum iterations (${g}). Possible infinite loop. Resetting to default.`),i;const a=o[n];if(!a)return console.warn(`[Storage Migration] No migration found for version ${n}. This is a breaking change. Resetting to default value.`),i;try{s=a.migrate(s);const u=a.to??n+1;if(u<=n)return console.error(`[Storage Migration] Migration from version ${n} did not advance (next: ${u}). Resetting to default.`),i;n=u}catch(u){return console.error(`[Storage Migration] Migration from version ${n} failed:`,u),i}}return s}const E={completedPuzzles:{},completedExpeditions:{},recentlyViewedPuzzles:[],version:1},v=10,M=p("puzzlestoneProgress",{version:1,defaultValue:E}),f=l.createContext(null);function $({children:r}){const[e,t]=M(),o=l.useMemo(()=>({progress:e,setProgress:t}),[e,t]);return z.jsx(f.Provider,{value:o,children:r})}function d(){const r=l.useContext(f);if(!r)throw new Error("useProgressContext must be used within a ProgressProvider");return r}function b(r,e){const{progress:t}=d();return r==="puzzle"?e in t.completedPuzzles:e in t.completedExpeditions}function V(r,e){const{progress:t}=d();return r==="puzzle"?t.completedPuzzles[e]??null:t.completedExpeditions[e]??null}function R(r,e){const{setProgress:t}=d();return l.useCallback(()=>{e&&t(o=>{if(r==="puzzle"?e in o.completedPuzzles:e in o.completedExpeditions)if(r==="puzzle"){const{[e]:n,...s}=o.completedPuzzles;return{...o,completedPuzzles:s}}else{const{[e]:n,...s}=o.completedExpeditions;return{...o,completedExpeditions:s}}else{const n=new Date().toISOString();return r==="puzzle"?{...o,completedPuzzles:{...o.completedPuzzles,[e]:n}}:{...o,completedExpeditions:{...o.completedExpeditions,[e]:n}}}})},[r,e,t])}function O(r){const{setProgress:e}=d();l.useEffect(()=>{r&&e(t=>{if(t.recentlyViewedPuzzles[0]===r)return t;const o=t.recentlyViewedPuzzles.filter(n=>n!==r),i=[r,...o].slice(0,v);return{...t,recentlyViewedPuzzles:i}})},[r])}function k(r){const{progress:e}=d();return r==="puzzle"?e.completedPuzzles:e.completedExpeditions}export{$ as P,b as a,O as b,R as c,V as d,k as u};
