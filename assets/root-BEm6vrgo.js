import{t as e,b as u,v as se,L as D,w as re,x as ne,M as Z,y as q,S as oe,z as Q,O as ae,A as ie,i as de}from"./index-DIth0oIc.js";import{L as le}from"./Logo-BRp-LhsU.js";import{u as ce,a as G}from"./use-dark-mode-mdHJdo6o.js";import{B as ee,c as v,R as O,A as U,a as V,e as T,b as $,P as ue,G as pe,X as fe,E as me,d as B,r as ge,t as Y,f as he,g as xe,h as we,i as be,j as ze,k as L,T as ye,C as ve,l as je,m as ke,n as Pe,o as Ee}from"./card-CRYRt8Xe.js";import{N as Ne,u as Se}from"./NavHeightContext-BwIQMGhB.js";import{e as H}from"./expeditionIndex-BBmHlwnS.js";import{p as M}from"./puzzleIndex-CkuFLq0I.js";import{L as Be}from"./loader-circle-D4Vxh6Q3.js";function Me(t,s){return()=>ce(...Ce(t,s))}function Ce(t,s){const{version:o,defaultValue:i,migrations:r,serializer:n,deserializer:p,initializeWithValue:g}=s;return Ie(r,o),[t,i,{serializer:x=>JSON.stringify({version:o,value:n?n(x):x}),deserializer:x=>{try{const c=JSON.parse(x);return c.version===o?p?p(c.value):c.value:c.version>o?(console.warn(`[Storage Migration] Stored version (${c.version}) is newer than current version (${o}). Resetting to default.`),i):Re(c.value,c.version,o,r,i)}catch(c){return console.error("[Storage Migration] Error during migration:",c),i}},initializeWithValue:g}]}function Ie(t,s){if(t)for(const[o,i]of Object.entries(t)){const r=parseInt(o,10),n=i.to??r+1;if(n<=r)throw new Error(`[Storage Migration] Invalid migration: version ${r} cannot migrate to ${n} (backwards or circular migration)`);n>s&&console.warn(`[Storage Migration] Migration from version ${r} targets version ${n}, which exceeds the current target version ${s}. This migration may not be reachable.`)}}function Re(t,s,o,i,r){if(!i)return console.warn("[Storage Migration] No migrations defined. Resetting to default value."),r;let n=s,p=t;const g=100;let m=0;for(;n<o;){if(m++,m>g)return console.error(`[Storage Migration] Migration exceeded maximum iterations (${g}). Possible infinite loop. Resetting to default.`),r;const x=i[n];if(!x)return console.warn(`[Storage Migration] No migration found for version ${n}. This is a breaking change. Resetting to default value.`),r;try{p=x.migrate(p);const c=x.to??n+1;if(c<=n)return console.error(`[Storage Migration] Migration from version ${n} did not advance (next: ${c}). Resetting to default.`),r;n=c}catch(c){return console.error(`[Storage Migration] Migration from version ${n} failed:`,c),r}}return p}function J(){const[t,s]=G();return e.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>s(!t),"aria-label":t?"Dark mode enabled. Switch to light mode":"Light mode enabled. Switch to dark mode","aria-pressed":t,suppressHydrationWarning:!0,children:e.jsxs("div",{children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:v(!t&&"hidden"),suppressHydrationWarning:!0,children:[e.jsx("circle",{cx:"12",cy:"12",r:"4"}),e.jsx("path",{d:"M12 2v2"}),e.jsx("path",{d:"M12 20v2"}),e.jsx("path",{d:"m4.93 4.93 1.41 1.41"}),e.jsx("path",{d:"m17.66 17.66 1.41 1.41"}),e.jsx("path",{d:"M2 12h2"}),e.jsx("path",{d:"M20 12h2"}),e.jsx("path",{d:"m6.34 17.66-1.41 1.41"}),e.jsx("path",{d:"m19.07 4.93-1.41 1.41"})]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:v(t&&"hidden"),suppressHydrationWarning:!0,children:e.jsx("path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"})})]})})}const Ae=u.forwardRef(function(s,o){const[i,r]=u.useState(!1),n=se(),p=m=>n.pathname===m,g=[{path:O.PUZZLES,label:"Puzzles"},{path:O.EXPEDITIONS,label:"Expeditions"},{path:O.PROGRESS,label:"Progress"}];return e.jsxs(e.Fragment,{children:[e.jsx("nav",{ref:o,className:"sticky top-0 z-[1000] border-b border-border bg-card",children:e.jsx("div",{className:"container mx-auto px-6",children:e.jsxs("div",{className:"flex h-16 items-center justify-between",children:[e.jsxs(D,{to:"/",className:"flex items-center gap-3 text-nav-foreground no-underline",children:[e.jsx(le,{className:"h-10 w-10 text-nav-foreground"}),e.jsx("span",{className:"text-[1.25rem] font-semibold leading-none",children:"Puzzlestone Peak"})]}),e.jsxs("div",{className:"hidden items-center gap-6 md:flex",children:[e.jsx("ul",{className:"flex items-center gap-8",children:g.map(m=>e.jsx("li",{children:e.jsx(D,{to:m.path,className:v("relative pb-2 text-[1rem] font-medium text-nav-foreground no-underline after:absolute after:bottom-0 after:left-0 after:h-[2px] after:w-0 after:bg-nav-foreground after:transition-all after:duration-200 hover:after:w-full",p(m.path)&&"after:w-full"),children:m.label})},m.path))}),e.jsx(J,{})]}),e.jsxs("button",{onClick:()=>r(!i),className:"flex h-8 w-8 cursor-pointer flex-col justify-around border-none bg-transparent p-1 text-nav-foreground md:hidden","aria-label":"Toggle mobile menu","aria-expanded":i,"aria-controls":"mobile-menu",children:[e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"}),e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"}),e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"})]})]})})}),e.jsx("div",{id:"mobile-menu",className:v("fixed left-0 right-0 top-16 z-[999] border-b border-border bg-card shadow-lg transition-all duration-300 md:hidden",i?"translate-y-0 opacity-100":"pointer-events-none -translate-y-full opacity-0"),children:e.jsxs("div",{className:"px-6 pb-6 pt-4",children:[e.jsx("ul",{className:"flex flex-col gap-3",children:g.map(m=>e.jsx("li",{children:e.jsx(D,{to:m.path,onClick:()=>r(!1),className:v("flex items-center border-l-[3px] px-4 py-3.5 text-base font-medium text-nav-foreground no-underline transition-all duration-200",p(m.path)?"border-l-nav-foreground bg-muted font-semibold":"border-l-transparent hover:border-l-nav-foreground hover:bg-muted"),children:m.label})},m.path))}),e.jsx("div",{className:"mt-4 flex justify-center border-t border-border pt-4",children:e.jsx(J,{})})]})})]})});function Te({children:t}){const s=u.useRef(null),o=Se();return u.useEffect(()=>{const i=()=>{s.current&&o(s.current.offsetHeight)};return i(),window.addEventListener("resize",i),()=>{window.removeEventListener("resize",i)}},[o]),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Ae,{ref:s}),e.jsx("main",{children:t})]})}function Le({children:t}){return e.jsx(Ne,{children:e.jsx(Te,{children:t})})}const _e="puzzlestoneProgress",De="puzzlestoneProgress_backup",Oe=2,$e=20,He=Me(_e,{version:Oe,defaultValue:{completedPuzzles:[],completedExpeditions:[],earnedBadges:[],lastSeenPuzzles:[]},serializer:t=>JSON.stringify(t),deserializer:t=>{try{const s=JSON.parse(t),o=Ge(s);return Ue(o)}catch(s){console.error("[Progress] Failed to deserialize progress, backing up and resetting:",s);try{const o=new Date().toISOString(),i=`${De}_${o}`;localStorage.setItem(i,t),console.warn(`[Progress] Corrupted data saved to "${i}". Check localStorage to recover your progress manually.`)}catch(o){console.error("[Progress] Failed to save backup:",o)}return{completedPuzzles:[],completedExpeditions:[],earnedBadges:[],lastSeenPuzzles:[]}}}});function Ge(t){const s=new Set(M.map(r=>r.id)),o=new Set(H.map(r=>r.id)),i=new Set(U.map(r=>r.id));return{completedPuzzles:t.completedPuzzles.filter(r=>s.has(r.id)),completedExpeditions:t.completedExpeditions.filter(r=>o.has(r.id)),earnedBadges:t.earnedBadges.filter(r=>i.has(r.badgeId)),lastSeenPuzzles:t.lastSeenPuzzles.filter(r=>s.has(r.id))}}function Ue(t){const s=C(t),o=new Set(t.earnedBadges.map(r=>r.badgeId)),i=[];for(const r of U){if(o.has(r.id))continue;T(r,s).type==="done"&&i.push({badgeId:r.id,earnedAt:Date.now()})}return i.length>0?{...t,earnedBadges:[...t.earnedBadges,...i]}:t}function C(t){const s=new Map(t.completedPuzzles.map(l=>[l.id,l])),o=new Map(t.completedExpeditions.map(l=>[l.id,l])),i=new Map(t.earnedBadges.map(l=>[l.badgeId,l])),r=[];for(const l of pe){const b=M.filter(E=>E.difficulty===l),N=b.filter(E=>s.has(E.id)).length,P=b.length;r.push({difficulty:l,completed:N,total:P,percentage:P>0?Math.round(N/P*100):0})}const n=M.filter(l=>l.difficulty!=="open").length,p=M.filter(l=>l.difficulty!=="open"&&s.has(l.id)).length,g=H.length,m=H.filter(l=>o.has(l.id)).length;let x=0;for(const l of M)s.has(l.id)&&(x+=fe[l.difficulty]);for(const l of t.earnedBadges){const b=$.get(l.badgeId);b?.xp&&(x+=b.xp)}x+=m*me;const c=B.slice().reverse().find(l=>x>=l.minXP)||B[0],j=B.findIndex(l=>l.id===c.id),k=j<B.length-1?B[j+1]:null,I=k?k.minXP-x:null;return{completedPuzzles:s,completedExpeditions:o,earnedBadges:i,lastSeenPuzzles:t.lastSeenPuzzles.slice().sort((l,b)=>b.viewedAt-l.viewedAt),totalXP:x,currentRank:c,nextRank:k,xpToNextRank:I,progressByDifficulty:r,totalProgress:{completed:p,total:n,percentage:n>0?Math.round(p/n*100):0},expeditionProgress:{completed:m,total:g,percentage:g>0?Math.round(m/g*100):0}}}function Xe({children:t,onBadgesEarned:s,onRankUp:o}){const[i,r]=He(),[n,p]=u.useState(()=>C(i)),g=u.useRef(s),m=u.useRef(o);u.useEffect(()=>{g.current=s,m.current=o},[s,o]),u.useEffect(()=>{const a=C(i);p(a)},[i]);const x=u.useCallback((a,d,h,w)=>{const z=[],y=U.filter(f=>{switch(w){case"puzzle":return f.condition.type==="content-badge"&&f.condition.contentType==="puzzle"||f.condition.type==="rank"||f.condition.type==="custom";case"expedition":return f.condition.type==="content-badge"&&f.condition.contentType==="expedition"||f.condition.type==="rank"||f.condition.type==="custom";default:return V(w)}});for(const f of y){const _=T(f,h),R=d.earnedBadges.has(f.id),W=_.type==="done";if(W&&!R){const S=Date.now();a.earnedBadges.push({badgeId:f.id,earnedAt:S}),h.earnedBadges.set(f.id,{badgeId:f.id,earnedAt:S}),z.push({badge:f,earnedAt:S})}else!W&&R&&(a.earnedBadges=a.earnedBadges.filter(S=>S.badgeId!==f.id),h.earnedBadges.delete(f.id))}return z},[]),c=u.useCallback((a,d)=>{r(h=>{const w=a(h),z=C(h),y=C(w),f=x(w,z,y,d);return f.length>0&&g.current&&g.current(f),y.currentRank.id!==z.currentRank.id&&m.current&&m.current(z.currentRank,y.currentRank),p(y),w})},[x]),j=u.useCallback(a=>{a&&c(d=>({...d,completedPuzzles:d.completedPuzzles.some(h=>h.id===a)?d.completedPuzzles:[...d.completedPuzzles,{id:a,completedAt:Date.now()}]}),"puzzle")},[c]),k=u.useCallback(a=>{a&&c(d=>({...d,completedPuzzles:d.completedPuzzles.filter(h=>h.id!==a)}),"puzzle")},[c]),I=u.useCallback(a=>n.completedPuzzles.has(a),[n.completedPuzzles]),l=u.useCallback(a=>{a&&r(d=>{const h=Date.now(),w=d.lastSeenPuzzles.filter(f=>f.id!==a),z=[{id:a,viewedAt:h},...w].slice(0,$e),y={...d,lastSeenPuzzles:z};return p(f=>({...f,lastSeenPuzzles:z.slice().sort((_,R)=>R.viewedAt-_.viewedAt)})),y})},[]),b=u.useCallback(a=>{const d=n.lastSeenPuzzles;return a!==void 0?d.slice(0,a):d},[n.lastSeenPuzzles]),N=u.useCallback(a=>{a&&c(d=>({...d,completedExpeditions:d.completedExpeditions.some(h=>h.id===a)?d.completedExpeditions:[...d.completedExpeditions,{id:a,completedAt:Date.now()}]}),"expedition")},[c]),P=u.useCallback(a=>{a&&c(d=>({...d,completedExpeditions:d.completedExpeditions.filter(h=>h.id!==a)}),"expedition")},[c]),E=u.useCallback(a=>n.completedExpeditions.has(a),[n.completedExpeditions]),X=u.useCallback(a=>{const d=$.get(a);return d?T(d,n):{type:"not-discovered"}},[n]),F=u.useCallback(a=>{const d=n.earnedBadges.get(a);if(d)return{type:"done",completedDate:new Date(d.earnedAt)};const h=$.get(a);if(!h)return{type:"hidden"};const w=T(h,n);switch(w.type){case"done":return{type:"done",completedDate:new Date};case"not-discovered":return{type:"hidden"};case"not-done":return{type:"not-done"};case"progress":return{type:"progress",current:w.current,total:w.total,percentage:w.percentage,label:w.label};default:return V(w)}},[n]),K=u.useCallback(()=>Array.from(n.earnedBadges.values()).sort((a,d)=>d.earnedAt-a.earnedAt).map(a=>({badgeId:a.badgeId,earnedAt:a.earnedAt})),[n.earnedBadges]),te=u.useMemo(()=>({userProgress:n,getBadgeProgress:X,getBadgeCompletionState:F,getRecentBadges:K,markPuzzleComplete:j,markPuzzleIncomplete:k,isPuzzleComplete:I,markPuzzleViewed:l,getLastSeenPuzzles:b,markExpeditionComplete:N,markExpeditionIncomplete:P,isExpeditionComplete:E,onBadgesEarned:s,onRankUp:o}),[n,X,F,K,j,k,I,l,b,N,P,E,s,o]);return e.jsx(ue.Provider,{value:te,children:t})}const Fe=300*1e3,A={BADGE_TITLE:t=>`Badge Earned: ${t}`,BADGE_DESCRIPTION:(t,s)=>`${t}${s?` (+${s} XP)`:""}`,RANK_UP_TITLE:t=>`Rank Up: ${t}`,RANK_UP_DESCRIPTION:"You've ascended to a new rank!"};function Ke(t,s){const o=Date.now(),i=new Set(t.map(r=>r.badge.id));return t.filter(({badge:r,earnedAt:n})=>!(s.has(r.id)||o-n<Fe&&o-n>1e3||i.has(he.id)&&[xe.id,we.id,be.id,ze.id].includes(r.id)))}function We(){const t=u.useRef(new Set(ge.map(i=>i.id))).current,s=u.useCallback(i=>{Ke(i,t).forEach(({badge:n})=>{Y.success(A.BADGE_TITLE(n.title),{description:A.BADGE_DESCRIPTION(n.description,n.xp)})})},[t]),o=u.useCallback((i,r)=>{Y.success(A.RANK_UP_TITLE(r.name),{description:A.RANK_UP_DESCRIPTION})},[]);return{handleBadgesEarned:s,handleRankUp:o}}/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ye=L("circle-check",Ve);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Ze=L("circle-x",Je);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Qe=L("info",qe);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],tt=L("triangle-alert",et),st=({...t})=>e.jsx(ye,{className:"toaster group",icons:{success:e.jsx(Ye,{className:"!text-success"}),error:e.jsx(Ze,{className:"!text-destructive"}),warning:e.jsx(tt,{className:"!text-warning"}),info:e.jsx(Qe,{className:"!text-info"}),loading:e.jsx(Be,{className:"animate-spin"})},toastOptions:{unstyled:!0,closeButton:!0,duration:1e9,classNames:{toast:"bg-card text-card-foreground border border-border shadow-lg rounded-lg font-sans p-4 flex gap-3 items-start w-full max-w-md data-[type=success]:border-success data-[type=error]:border-destructive data-[type=warning]:border-warning data-[type=info]:border-info",title:"font-semibold text-base",description:"text-muted-foreground text-sm mt-1",actionButton:"bg-primary text-primary-foreground hover:bg-primary/90 rounded-md px-3 py-2 font-medium text-sm transition-colors",cancelButton:"bg-muted text-muted-foreground hover:bg-muted/80 rounded-md px-3 py-2 text-sm transition-colors",closeButton:"size-auto bg-card hover:bg-muted !transition-colors text-card-foreground border border-border rounded-full p-1 absolute top-0 right-0 transform-[translate(50%,-50%)] [&>svg]:size-4 cursor-pointer"}},...t}),rt="/assets/poppins-400-cpxAROuN.woff2",nt="/assets/poppins-500-C8OXljZJ.woff2",ot="/assets/poppins-600-zEkxB9Mr.woff2",at="/assets/poppins-700-Qrb0O0WB.woff2";function gt({children:t}){const[s]=G();return e.jsxs("html",{lang:"en",className:v(s?"dark":void 0),suppressHydrationWarning:!0,children:[e.jsxs("head",{children:[e.jsx("meta",{charSet:"UTF-8"}),e.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),e.jsx("meta",{name:"color-scheme",content:"dark light"}),e.jsx("link",{rel:"preload",href:rt,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("link",{rel:"preload",href:nt,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("link",{rel:"preload",href:ot,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("link",{rel:"preload",href:at,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("script",{dangerouslySetInnerHTML:{__html:`
              (function initTheme() {
                if (localStorage.getItem('darkmode') === '1') {
                  document.documentElement.classList.add('dark');
                }
              })();
            `}}),e.jsx("script",{async:!0,src:"https://www.googletagmanager.com/gtag/js?id=G-1LM5FNK1VX"}),e.jsx("script",{dangerouslySetInnerHTML:{__html:`
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'G-1LM5FNK1VX');
            `}}),e.jsx(Z,{}),e.jsx(q,{})]}),e.jsxs("body",{children:[t,e.jsx(oe,{}),e.jsx(Q,{})]})]})}const ht=re(function(){const{handleBadgesEarned:s,handleRankUp:o}=We();return e.jsxs(Xe,{onBadgesEarned:s,onRankUp:o,children:[e.jsx(st,{}),e.jsx(Le,{children:e.jsx(ae,{})})]})}),xt=ne(function(){const s=ie(),[o]=G(),[i,r]=u.useState(!1);let n=500,p="Application Error",g="An unexpected error occurred while loading this page.";return de(s)?(n=s.status,s.data?.message||s.statusText,s.status===404?(p="Page Not Found",g="The page you are looking for does not exist."):s.status===500?(p="Server Error",g="Something went wrong on our end. Please try again later."):s.status===403?(p="Access Denied",g="You do not have permission to access this page."):(p=`Error ${s.status}`,g=s.statusText||"An error occurred.")):s instanceof Error&&(s.message,p="Application Error",g="An unexpected error occurred while loading this page."),e.jsxs("html",{lang:"en",className:v(o?"dark":void 0),children:[e.jsxs("head",{children:[e.jsx("meta",{charSet:"UTF-8"}),e.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),e.jsx("title",{children:`${p} - Puzzlestone Peak`}),e.jsx(Z,{}),e.jsx(q,{})]}),e.jsxs("body",{children:[e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-6",children:e.jsxs(ve,{className:"max-w-2xl w-full",children:[e.jsx(je,{children:e.jsxs(ke,{className:"flex items-center gap-3 text-2xl",children:[e.jsx("span",{className:"text-4xl text-destructive",children:"âš "}),p]})}),e.jsxs(Pe,{className:"space-y-6",children:[e.jsx("p",{className:"text-muted-foreground",children:g}),n===404?e.jsx("p",{className:"text-sm text-foreground",children:"The page you requested could not be found. It may have been moved or deleted."}):e.jsx("p",{className:"text-sm text-foreground",children:"If this problem persists, please try clearing your browser cache or contact support."}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsx(Ee,{to:"/",variant:"contained",color:"primary",children:"Return Home"}),e.jsx(ee,{variant:"outlined",onClick:()=>window.location.reload(),children:"Reload Page"})]}),!1]})]})}),e.jsx(Q,{})]})]})});export{xt as ErrorBoundary,gt as Layout,ht as default};
