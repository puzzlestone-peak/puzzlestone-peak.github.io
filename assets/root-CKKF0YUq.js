import{t as e,b as u,v as se,L as D,w as ne,x as oe,M as q,y as Q,S as ae,z as ee,O as ie,A as de,i as le}from"./index-DIth0oIc.js";import{L as ce}from"./Logo-BRp-LhsU.js";import{u as ue,a as H}from"./use-dark-mode-mdHJdo6o.js";import{B as te,c as v,R as _,A as G,a as V,e as L,b as O,P as pe,X as fe,E as me,d as C,r as ge,t as Y,f as he,g as xe,h as be,i as we,j as ze,k as U,T as ye,l as ve,C as je,m as ke,n as Pe,o as Ee,p as Ne}from"./card-fxtljBLB.js";import{N as Se,u as Be}from"./NavHeightContext-BwIQMGhB.js";import{G as Ce,i as J}from"./difficulty-types-Yz_I7Ggm.js";import{expeditionIndex as $}from"./expeditionIndex-fN_P2HPz.js";import{puzzleIndex as M}from"./puzzleIndex-Cs9faEoZ.js";import{L as Me}from"./loader-circle-liqmjHjk.js";function Ie(t,r){return()=>ue(...Re(t,r))}function Re(t,r){const{version:o,defaultValue:i,migrations:s,serializer:n,deserializer:p,initializeWithValue:g}=r;return Te(s,o),[t,i,{serializer:x=>JSON.stringify({version:o,value:n?n(x):x}),deserializer:x=>{try{const c=JSON.parse(x);return c.version===o?p?p(c.value):c.value:c.version>o?(console.warn(`[Storage Migration] Stored version (${c.version}) is newer than current version (${o}). Resetting to default.`),i):Ae(c.value,c.version,o,s,i)}catch(c){return console.error("[Storage Migration] Error during migration:",c),i}},initializeWithValue:g}]}function Te(t,r){if(t)for(const[o,i]of Object.entries(t)){const s=parseInt(o,10),n=i.to??s+1;if(n<=s)throw new Error(`[Storage Migration] Invalid migration: version ${s} cannot migrate to ${n} (backwards or circular migration)`);n>r&&console.warn(`[Storage Migration] Migration from version ${s} targets version ${n}, which exceeds the current target version ${r}. This migration may not be reachable.`)}}function Ae(t,r,o,i,s){if(!i)return console.warn("[Storage Migration] No migrations defined. Resetting to default value."),s;let n=r,p=t;const g=100;let m=0;for(;n<o;){if(m++,m>g)return console.error(`[Storage Migration] Migration exceeded maximum iterations (${g}). Possible infinite loop. Resetting to default.`),s;const x=i[n];if(!x)return console.warn(`[Storage Migration] No migration found for version ${n}. This is a breaking change. Resetting to default value.`),s;try{p=x.migrate(p);const c=x.to??n+1;if(c<=n)return console.error(`[Storage Migration] Migration from version ${n} did not advance (next: ${c}). Resetting to default.`),s;n=c}catch(c){return console.error(`[Storage Migration] Migration from version ${n} failed:`,c),s}}return p}function Z(){const[t,r]=H();return e.jsx(te,{variant:"ghost",size:"icon",onClick:()=>r(!t),"aria-label":t?"Dark mode enabled. Switch to light mode":"Light mode enabled. Switch to dark mode","aria-pressed":t,suppressHydrationWarning:!0,children:e.jsxs("div",{children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:v(!t&&"hidden"),suppressHydrationWarning:!0,children:[e.jsx("circle",{cx:"12",cy:"12",r:"4"}),e.jsx("path",{d:"M12 2v2"}),e.jsx("path",{d:"M12 20v2"}),e.jsx("path",{d:"m4.93 4.93 1.41 1.41"}),e.jsx("path",{d:"m17.66 17.66 1.41 1.41"}),e.jsx("path",{d:"M2 12h2"}),e.jsx("path",{d:"M20 12h2"}),e.jsx("path",{d:"m6.34 17.66-1.41 1.41"}),e.jsx("path",{d:"m19.07 4.93-1.41 1.41"})]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:v(t&&"hidden"),suppressHydrationWarning:!0,children:e.jsx("path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"})})]})})}const Le=u.forwardRef(function(r,o){const[i,s]=u.useState(!1),n=se(),p=m=>n.pathname===m,g=[{path:_.PUZZLES,label:"Puzzles"},{path:_.EXPEDITIONS,label:"Expeditions"},{path:_.PROGRESS,label:"Progress"}];return e.jsxs(e.Fragment,{children:[e.jsx("nav",{ref:o,className:"sticky top-0 z-[1000] border-b border-border bg-card",children:e.jsx("div",{className:"container mx-auto px-6",children:e.jsxs("div",{className:"flex h-16 items-center justify-between",children:[e.jsxs(D,{to:"/",className:"flex items-center gap-3 text-nav-foreground no-underline",children:[e.jsx(ce,{className:"h-10 w-10 text-nav-foreground"}),e.jsx("span",{className:"text-[1.25rem] font-semibold leading-none",children:"Puzzlestone Peak"})]}),e.jsxs("div",{className:"hidden items-center gap-6 md:flex",children:[e.jsx("ul",{className:"flex items-center gap-8",children:g.map(m=>e.jsx("li",{children:e.jsx(D,{to:m.path,className:v("relative pb-2 text-[1rem] font-medium text-nav-foreground no-underline after:absolute after:bottom-0 after:left-0 after:h-[2px] after:w-0 after:bg-nav-foreground after:transition-all after:duration-200 hover:after:w-full",p(m.path)&&"after:w-full"),children:m.label})},m.path))}),e.jsx(Z,{})]}),e.jsxs("button",{onClick:()=>s(!i),className:"flex h-8 w-8 cursor-pointer flex-col justify-around border-none bg-transparent p-1 text-nav-foreground md:hidden","aria-label":"Toggle mobile menu","aria-expanded":i,"aria-controls":"mobile-menu",children:[e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"}),e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"}),e.jsx("span",{className:"block h-[2px] w-full bg-current transition-all duration-300"})]})]})})}),e.jsx("div",{id:"mobile-menu",className:v("fixed left-0 right-0 top-16 z-[999] border-b border-border bg-card shadow-lg transition-all duration-300 md:hidden",i?"translate-y-0 opacity-100":"pointer-events-none -translate-y-full opacity-0"),children:e.jsxs("div",{className:"px-6 pb-6 pt-4",children:[e.jsx("ul",{className:"flex flex-col gap-3",children:g.map(m=>e.jsx("li",{children:e.jsx(D,{to:m.path,onClick:()=>s(!1),className:v("flex items-center border-l-[3px] px-4 py-3.5 text-base font-medium text-nav-foreground no-underline transition-all duration-200",p(m.path)?"border-l-nav-foreground bg-muted font-semibold":"border-l-transparent hover:border-l-nav-foreground hover:bg-muted"),children:m.label})},m.path))}),e.jsx("div",{className:"mt-4 flex justify-center border-t border-border pt-4",children:e.jsx(Z,{})})]})})]})});function De({children:t}){const r=u.useRef(null),o=Be();return u.useEffect(()=>{const i=()=>{r.current&&o(r.current.offsetHeight)};return i(),window.addEventListener("resize",i),()=>{window.removeEventListener("resize",i)}},[o]),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Le,{ref:r}),e.jsx("main",{children:t})]})}function _e({children:t}){return e.jsx(Se,{children:e.jsx(De,{children:t})})}const Oe="puzzlestoneProgress",$e="puzzlestoneProgress_backup",He=2,Ge=20,Ue=Ie(Oe,{version:He,defaultValue:{completedPuzzles:[],completedExpeditions:[],earnedBadges:[],lastSeenPuzzles:[]},serializer:t=>JSON.stringify(t),deserializer:t=>{try{const r=JSON.parse(t),o=Fe(r);return Xe(o)}catch(r){console.error("[Progress] Failed to deserialize progress, backing up and resetting:",r);try{const o=new Date().toISOString(),i=`${$e}_${o}`;localStorage.setItem(i,t),console.warn(`[Progress] Corrupted data saved to "${i}". Check localStorage to recover your progress manually.`)}catch(o){console.error("[Progress] Failed to save backup:",o)}return{completedPuzzles:[],completedExpeditions:[],earnedBadges:[],lastSeenPuzzles:[]}}}});function Fe(t){const r=new Set(M.map(s=>s.id)),o=new Set($.map(s=>s.id)),i=new Set(G.map(s=>s.id));return{completedPuzzles:t.completedPuzzles.filter(s=>r.has(s.id)),completedExpeditions:t.completedExpeditions.filter(s=>o.has(s.id)),earnedBadges:t.earnedBadges.filter(s=>i.has(s.badgeId)),lastSeenPuzzles:t.lastSeenPuzzles.filter(s=>r.has(s.id))}}function Xe(t){const r=I(t),o=new Set(t.earnedBadges.map(s=>s.badgeId)),i=[];for(const s of G){if(o.has(s.id))continue;L(s,r).type==="done"&&i.push({badgeId:s.id,earnedAt:Date.now()})}return i.length>0?{...t,earnedBadges:[...t.earnedBadges,...i]}:t}function I(t){const r=new Map(t.completedPuzzles.map(l=>[l.id,l])),o=new Map(t.completedExpeditions.map(l=>[l.id,l])),i=new Map(t.earnedBadges.map(l=>[l.badgeId,l])),s=[];for(const l of Ce){const w=M.filter(E=>E.difficulty===l),N=w.filter(E=>r.has(E.id)).length,P=w.length;s.push({difficulty:l,completed:N,total:P,percentage:P>0?Math.round(N/P*100):0})}const n=M.filter(l=>J(l.difficulty)).length,p=M.filter(l=>J(l.difficulty)&&r.has(l.id)).length,g=$.length,m=$.filter(l=>o.has(l.id)).length;let x=0;for(const l of M)r.has(l.id)&&(x+=fe[l.difficulty]);for(const l of t.earnedBadges){const w=O.get(l.badgeId);w?.xp&&(x+=w.xp)}x+=m*me;const c=C.slice().reverse().find(l=>x>=l.minXP)||C[0],j=C.findIndex(l=>l.id===c.id),k=j<C.length-1?C[j+1]:null,R=k?k.minXP-x:null;return{completedPuzzles:r,completedExpeditions:o,earnedBadges:i,lastSeenPuzzles:t.lastSeenPuzzles.slice().sort((l,w)=>w.viewedAt-l.viewedAt),totalXP:x,currentRank:c,nextRank:k,xpToNextRank:R,progressByDifficulty:s,totalProgress:{completed:p,total:n,percentage:n>0?Math.round(p/n*100):0},expeditionProgress:{completed:m,total:g,percentage:g>0?Math.round(m/g*100):0}}}function Ke({children:t,onBadgesEarned:r,onRankUp:o}){const[i,s]=Ue(),[n,p]=u.useState(()=>I(i)),g=u.useRef(r),m=u.useRef(o);u.useEffect(()=>{g.current=r,m.current=o},[r,o]),u.useEffect(()=>{const a=I(i);p(a)},[i]);const x=u.useCallback((a,d,h,b)=>{const z=[],y=G.filter(f=>{switch(b){case"puzzle":return f.condition.type==="content-badge"&&f.condition.contentType==="puzzle"||f.condition.type==="rank"||f.condition.type==="custom";case"expedition":return f.condition.type==="content-badge"&&f.condition.contentType==="expedition"||f.condition.type==="rank"||f.condition.type==="custom";default:return V(b)}});for(const f of y)try{const S=L(f,h),T=d.earnedBadges.has(f.id),W=S.type==="done";if(W&&!T){const B=Date.now();a.earnedBadges.push({badgeId:f.id,earnedAt:B}),h.earnedBadges.set(f.id,{badgeId:f.id,earnedAt:B}),z.push({badge:f,earnedAt:B})}else!W&&T&&(a.earnedBadges=a.earnedBadges.filter(B=>B.badgeId!==f.id),h.earnedBadges.delete(f.id))}catch(S){console.error(`Failed to evaluate badge ${f.id}:`,S)}return z},[]),c=u.useCallback((a,d)=>{s(h=>{const b=a(h),z=I(h),y=I(b),f=x(b,z,y,d);return f.length>0&&g.current&&g.current(f),y.currentRank.id!==z.currentRank.id&&m.current&&m.current(z.currentRank,y.currentRank),p(y),b})},[x]),j=u.useCallback(a=>{a&&c(d=>({...d,completedPuzzles:d.completedPuzzles.some(h=>h.id===a)?d.completedPuzzles:[...d.completedPuzzles,{id:a,completedAt:Date.now()}]}),"puzzle")},[c]),k=u.useCallback(a=>{a&&c(d=>({...d,completedPuzzles:d.completedPuzzles.filter(h=>h.id!==a)}),"puzzle")},[c]),R=u.useCallback(a=>n.completedPuzzles.has(a),[n.completedPuzzles]),l=u.useCallback(a=>{a&&s(d=>{const h=Date.now(),b=d.lastSeenPuzzles.filter(f=>f.id!==a),z=[{id:a,viewedAt:h},...b].slice(0,Ge),y={...d,lastSeenPuzzles:z};return p(f=>({...f,lastSeenPuzzles:z.slice().sort((S,T)=>T.viewedAt-S.viewedAt)})),y})},[]),w=u.useCallback(a=>{const d=n.lastSeenPuzzles;return a!==void 0?d.slice(0,a):d},[n.lastSeenPuzzles]),N=u.useCallback(a=>{a&&c(d=>({...d,completedExpeditions:d.completedExpeditions.some(h=>h.id===a)?d.completedExpeditions:[...d.completedExpeditions,{id:a,completedAt:Date.now()}]}),"expedition")},[c]),P=u.useCallback(a=>{a&&c(d=>({...d,completedExpeditions:d.completedExpeditions.filter(h=>h.id!==a)}),"expedition")},[c]),E=u.useCallback(a=>n.completedExpeditions.has(a),[n.completedExpeditions]),F=u.useCallback(a=>{const d=O.get(a);return d?L(d,n):{type:"not-discovered"}},[n]),X=u.useCallback(a=>{const d=n.earnedBadges.get(a);if(d)return{type:"done",completedDate:new Date(d.earnedAt)};const h=O.get(a);if(!h)return{type:"hidden"};const b=L(h,n);switch(b.type){case"done":return{type:"done",completedDate:new Date};case"not-discovered":return{type:"hidden"};case"not-done":return{type:"not-done"};case"progress":return{type:"progress",current:b.current,total:b.total,percentage:b.percentage,label:b.label};default:return V(b)}},[n]),K=u.useCallback(()=>Array.from(n.earnedBadges.values()).sort((a,d)=>d.earnedAt-a.earnedAt).map(a=>({badgeId:a.badgeId,earnedAt:a.earnedAt})),[n.earnedBadges]),re=u.useMemo(()=>({userProgress:n,getBadgeProgress:F,getBadgeCompletionState:X,getRecentBadges:K,markPuzzleComplete:j,markPuzzleIncomplete:k,isPuzzleComplete:R,markPuzzleViewed:l,getLastSeenPuzzles:w,markExpeditionComplete:N,markExpeditionIncomplete:P,isExpeditionComplete:E,onBadgesEarned:r,onRankUp:o}),[n,F,X,K,j,k,R,l,w,N,P,E,r,o]);return e.jsx(pe.Provider,{value:re,children:t})}const We=300*1e3,A={BADGE_TITLE:t=>`Badge Earned: ${t}`,BADGE_DESCRIPTION:(t,r)=>`${t}${r?` (+${r} XP)`:""}`,RANK_UP_TITLE:t=>`Rank Up: ${t}`,RANK_UP_DESCRIPTION:"You've ascended to a new rank!"};function Ve(t,r){const o=Date.now(),i=new Set(t.map(s=>s.badge.id));return t.filter(({badge:s,earnedAt:n})=>!(r.has(s.id)||o-n<We&&o-n>1e3||i.has(he.id)&&[xe.id,be.id,we.id,ze.id].includes(s.id)))}function Ye(){const t=u.useRef(new Set(ge.map(i=>i.id))).current,r=u.useCallback(i=>{Ve(i,t).forEach(({badge:n})=>{Y.success(A.BADGE_TITLE(n.title),{description:A.BADGE_DESCRIPTION(n.description,n.xp)})})},[t]),o=u.useCallback((i,s)=>{Y.success(A.RANK_UP_TITLE(s.name),{description:A.RANK_UP_DESCRIPTION})},[]);return{handleBadgesEarned:r,handleRankUp:o}}/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ze=U("circle-check",Je);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Qe=U("circle-x",qe);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],tt=U("info",et),rt=({...t})=>e.jsx(ye,{className:"toaster group",icons:{success:e.jsx(Ze,{className:"!text-success"}),error:e.jsx(Qe,{className:"!text-destructive"}),warning:e.jsx(ve,{className:"!text-warning"}),info:e.jsx(tt,{className:"!text-info"}),loading:e.jsx(Me,{className:"animate-spin"})},toastOptions:{unstyled:!0,closeButton:!0,duration:1e9,classNames:{toast:"bg-card text-card-foreground border border-border shadow-lg rounded-lg font-sans p-4 flex gap-3 items-start w-full max-w-md data-[type=success]:border-success data-[type=error]:border-destructive data-[type=warning]:border-warning data-[type=info]:border-info",title:"font-semibold text-base",description:"text-muted-foreground text-sm mt-1",actionButton:"bg-primary text-primary-foreground hover:bg-primary/90 rounded-md px-3 py-2 font-medium text-sm transition-colors",cancelButton:"bg-muted text-muted-foreground hover:bg-muted/80 rounded-md px-3 py-2 text-sm transition-colors",closeButton:"size-auto bg-card hover:bg-muted !transition-colors text-card-foreground border border-border rounded-full p-1 absolute top-0 right-0 transform-[translate(50%,-50%)] [&>svg]:size-4 cursor-pointer"}},...t}),st="/assets/poppins-400-cpxAROuN.woff2",nt="/assets/poppins-500-C8OXljZJ.woff2",ot="/assets/poppins-600-zEkxB9Mr.woff2",at="/assets/poppins-700-Qrb0O0WB.woff2";function ht({children:t}){const[r]=H();return e.jsxs("html",{lang:"en",className:v(r?"dark":void 0),suppressHydrationWarning:!0,children:[e.jsxs("head",{children:[e.jsx("meta",{charSet:"UTF-8"}),e.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),e.jsx("meta",{name:"color-scheme",content:"dark light"}),e.jsx("link",{rel:"preload",href:st,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("link",{rel:"preload",href:nt,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("link",{rel:"preload",href:ot,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("link",{rel:"preload",href:at,as:"font",type:"font/woff2",crossOrigin:"anonymous"}),e.jsx("script",{dangerouslySetInnerHTML:{__html:`
              (function initTheme() {
                if (localStorage.getItem('darkmode') === '1') {
                  document.documentElement.classList.add('dark');
                }
              })();
            `}}),e.jsx("script",{async:!0,src:"https://www.googletagmanager.com/gtag/js?id=G-1LM5FNK1VX"}),e.jsx("script",{dangerouslySetInnerHTML:{__html:`
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'G-1LM5FNK1VX');
            `}}),e.jsx(q,{}),e.jsx(Q,{})]}),e.jsxs("body",{children:[t,e.jsx(ae,{}),e.jsx(ee,{})]})]})}const xt=ne(function(){const{handleBadgesEarned:r,handleRankUp:o}=Ye();return e.jsxs(Ke,{onBadgesEarned:r,onRankUp:o,children:[e.jsx(rt,{}),e.jsx(_e,{children:e.jsx(ie,{})})]})}),bt=oe(function(){const r=de(),[o]=H(),[i,s]=u.useState(!1);let n=500,p="Application Error",g="An unexpected error occurred while loading this page.";return le(r)?(n=r.status,r.data?.message||r.statusText,r.status===404?(p="Page Not Found",g="The page you are looking for does not exist."):r.status===500?(p="Server Error",g="Something went wrong on our end. Please try again later."):r.status===403?(p="Access Denied",g="You do not have permission to access this page."):(p=`Error ${r.status}`,g=r.statusText||"An error occurred.")):r instanceof Error&&(r.message,p="Application Error",g="An unexpected error occurred while loading this page."),e.jsxs("html",{lang:"en",className:v(o?"dark":void 0),children:[e.jsxs("head",{children:[e.jsx("meta",{charSet:"UTF-8"}),e.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),e.jsx("title",{children:`${p} - Puzzlestone Peak`}),e.jsx(q,{}),e.jsx(Q,{})]}),e.jsxs("body",{children:[e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-6",children:e.jsxs(je,{className:"max-w-2xl w-full",children:[e.jsx(ke,{children:e.jsxs(Pe,{className:"flex items-center gap-3 text-2xl",children:[e.jsx("span",{className:"text-4xl text-destructive",children:"âš "}),p]})}),e.jsxs(Ee,{className:"space-y-6",children:[e.jsx("p",{className:"text-muted-foreground",children:g}),n===404?e.jsx("p",{className:"text-sm text-foreground",children:"The page you requested could not be found. It may have been moved or deleted."}):e.jsx("p",{className:"text-sm text-foreground",children:"If this problem persists, please try clearing your browser cache or contact support."}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsx(Ne,{to:"/",variant:"contained",color:"primary",children:"Return Home"}),e.jsx(te,{variant:"outlined",onClick:()=>window.location.reload(),children:"Reload Page"})]}),!1]})]})}),e.jsx(ee,{})]})]})});export{bt as ErrorBoundary,ht as Layout,xt as default};
